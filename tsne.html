<!DOCTYPE html>
<html>

    <head>
        <title>t-SNE Visualization with D3.js</title>
        <!-- Include D3.js from CDN -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <style>
        .axis line,
        .axis path {
            stroke: black;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 10px;
        }

        circle {
            opacity: 0.8;
        }
    </style>
    </head>

    <body>
        <!-- The SVG element that will contain our visualization -->
        <label for="layerwise-proxy-select">Proxy:</label>
        <select id="layerwise-proxy-select">
            <option value="fisher_layerwise">fisher_layerwise</option>
            <option value="grad_norm_layerwise">grad_norm_layerwise</option>
            <option value="grasp_layerwise">grasp_layerwise</option>
            <option value="l2_norm_layerwise">l2_norm_layerwise</option>
            <option value="plain_layerwise">plain_layerwise</option>
            <option value="snip_layerwise">snip_layerwise</option>
            <option value="synflow_layerwise">synflow_layerwise</option>
        </select>
        <br>
        <div id="my_dataviz"></div>

        <script>
        function transformData(proxyData) {
            return proxyData.x1.map((x, i) => ({
                x1: x,
                x2: proxyData.x2[i],
                color: proxyData.color
            }));
        }

        Promise.all([
            d3.json('data/tsne_nb201_output.json'),
            d3.json('data/processed_zc_nasbench201_layerwise.json')
        ]).then(function ([tsneData, layerwiseData]) {
            // Initial drawing with 'fisher_layerwise'
            drawTsne(transformData(tsneData['fisher_layerwise']), layerwiseData, 'fisher_layerwise');

            // Setup the event listener for the dropdown menu
            d3.select('#layerwise-proxy-select').on('change', function (event) {
                var selectedProxy = d3.select(this).property('value');
                d3.select('#my_dataviz').selectAll('*').remove();
                drawTsne(transformData(tsneData[selectedProxy]), layerwiseData, selectedProxy);
            });
        });

        function drawTsne(tsneData, layerwiseData, proxyname) {
            const info = d3.select("#my_dataviz")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0.5)
                .style("position", "absolute")
                .style("pointer-events", "none")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "2px")
                .style("border-radius", "5px")
                .style("padding", "5px");

            const vlineSvg = d3.select("#my_dataviz")
                .append("svg")
                .style("opacity", 0)
                .style("left", "60px")
                .style("position", "absolute")
                .style("pointer-events", "none")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "2px")
                .style("border-radius", "5px")
                .style("padding", "5px");

            var margin = { top: 10, right: 30, bottom: 30, left: 40 },
                width = 800 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;

            // Append the svg object to the body of the page
            var svg_tsne = d3.select("#my_dataviz")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

            // Add X axis
            var x = d3.scaleLinear()
                .domain([d3.min(tsneData, d => d.x1), d3.max(tsneData, d => d.x1)])
                .range([0, width]);
            svg_tsne.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

            // Add Y axis
            var y = d3.scaleLinear()
                .domain([d3.min(tsneData, d => d.x2), d3.max(tsneData, d => d.x2)])
                .range([height, 0]);
            svg_tsne.append("g")
                .call(d3.axisLeft(y));

            // Color scale: give me a specie name, I return a color
            var color_scale = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(['steelblue', 'darkorange', 'forestgreen', 'firebrick', 'darkviolet', 'gold', 'black']);

            svg_tsne.selectAll("dot")
                .data(tsneData)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.x1))
                .attr("cy", d => y(d.x2))
                .attr("r", 5)
                .style("fill", d => color_scale(d.color))
                .on("mouseover", function (event, d) {
                    info.style("opacity", 1);

                    // Enlarge the circle
                    d3.select(this).transition()
                        .duration('50')
                        .attr("r", 20)
                        .attr("fill", "red")
                        .attr("opacity", 1);

                    // Assuming 'i' is the index you need
                    let i = tsneData.indexOf(d);
                    var stats = layerwiseData["cifar10"][i.toString()][proxyname];
                    var indices = stats.map((_, index) => index);
                    var combinedData = stats.map((value, index) => ({ value, index }));

                    // Define separate scales for the vertical line chart if needed
                    var vlineX = d3.scaleBand()
                        .range([0, 300])
                        .domain(combinedData.map(d => d.index))
                        .padding(0.1);

                    var vlineY = d3.scaleLinear()
                        .range([150, 0])
                        .domain([0, d3.max(combinedData, d => d.value)]);

                    vlineSvg.style("opacity", 1); // Make the SVG visible

                    // Add Y axis for vlineSvg chart
                    vlineSvg.append("g")
                        .call(d3.axisLeft(vlineY));
                    
                    console.log(combinedData);

                    vlineSvg.selectAll(".bar").data(combinedData).enter().append("rect").attr("class", "bar")
                        .attr("x", d => vlineX(d.index)).attr("y", d => vlineY(d.value))
                        .attr("width", vlineX.bandwidth())
                        .attr("height", d => 150 - vlineY(d.value))
                        .attr("fill", color_scale(d.color));

                })
                .on("mousemove", function (event, d) {
                    info.html("Proxy: " + proxyname + "<br>" + "X1: " + d.x1 + "<br>X2: " + d.x2)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY + 10) + "px");
                })
                .on("mouseleave", function () { info.style("opacity", 0); })
                .on("mouseout", function (d) {
                    // Restore the circle
                    d3.select(this).transition()
                        .duration('50')
                        .attr("r", 2);
                    vlineSvg.style("opacity", 0);
                    vlineSvg.selectAll(".bar").remove();
                });

        }

    </script>

        <!-- svg_tsne.append('g')
                .selectAll("dot")
                .data(tsneData)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.x1))
                .attr("cy", d => y(d.x2))
                .attr("r", 2)
                .style("fill", d => color_scale(d.color))
                .on("mouseover", function (event, d) {
                    // Enlarge the circle
                    d3.select(this).transition()
                        .duration('50')
                        .attr("r", 20)
                        .attr("fill", "red")
                        .attr("opacity", 1);

                    // Assuming 'i' is the index you need
                    let i = tsneData.indexOf(d);
                    var stats = layerwiseData["cifar10"][i.toString()][proxyname];

                    // add info text for info div 
                    console.log(event.x, event.y)
                    info.html("Proxy: " + proxyname + "<br>" + "Value: " + d.value)
                        .style("left", (event.x) / 2 + "px")
                        .style("top", (event.y) / 2 + "px");

                    var indices = stats.map((_, index) => index);
                    var combinedData = stats.map((value, index) => ({ value, index }));

                    // X axis
                    const x = d3.scaleBand()
                        .range([0, width])
                        .domain(combinedData.map(function (d) { return d.index; }))
                        .padding(1);

                    tooltip.append("g")
                        .attr("transform", `translate(0, ${height})`)
                        .call(d3.axisBottom(x))
                        .selectAll("text")
                        .attr("transform", "translate(-10,0)rotate(-45)")
                        .style("text-anchor", "end");

                    // Add Y axis
                    const y = d3.scaleLinear()
                        .domain([0, d3.max(combinedData, function (d) { return d.value; })]) // Use the maximum value in your data
                        .range([height, 0]);

                    tooltip.append("g")
                        .call(d3.axisLeft(y));

                    // Lines (lollipop stems)
                    tooltip.selectAll("myline")
                        .data(combinedData)
                        .enter()
                        .append("line")
                        .attr("x1", function (d) { return x(d.index) + x.bandwidth() / 2; }) // Adjust x position for the center of the band
                        .attr("x2", function (d) { return x(d.index) + x.bandwidth() / 2; }) // Adjust x position for the center of the band
                        .attr("y1", function (d) { return y(d.value); })
                        .attr("y2", y(0))
                        .attr("stroke", "grey");

                    // Circles (lollipop heads)
                    tooltip.selectAll("mycircle")
                        .data(combinedData)
                        .enter()
                        .append("circle")
                        .attr("cx", function (d) { return x(d.index) + x.bandwidth() / 2; }) // Adjust x position for the center of the band
                        .attr("cy", function (d) { return y(d.value); })
                        .attr("r", "4")
                        .style("fill", "#69b3a2")
                        .attr("stroke", "black");
                })
                .on("mouseout", function (d) {
                    // Restore the circle
                    d3.select(this).transition()
                        .duration('50')
                        .attr("r", 2);
                    // Hide and clear the tooltip
                    tooltip.style("opacity", 0);
                    // tooltip.selectAll(".bar").remove();
                    // Clear all the elements inside the tooltip SVG
                    tooltip.selectAll("*").remove();
                }); -->
    </body>

</html>